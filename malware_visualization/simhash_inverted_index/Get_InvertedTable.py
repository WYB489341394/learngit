import json
import os
from simhash import Simhash
import getSimFuncSet as GSF

if __name__ == '__main__':
    '''
        {
            "7afe4ce85ef70de0": {
                "BlockName": "sub_4040BC", 
                "FuncName": "sub_4040BC", 
                "FileName": "9_11.asm"
            }, 
            "dac0e56c70e7201c": {
                "BlockName": "loc_411500", 
                "FuncName": "sub_411450", 
                "FileName": "9_8.asm"
            }, 
            "aed1c4407a33b0e0": {
                "BlockName": "loc_404D31", 
                "FuncName": "sub_404C7D", 
                "FileName": "9_63.asm"
            },
            ......

        }
    '''

    ExtTrain = r'F:\virtus_test\asm_file\ExtTrain'
    SimOutPath = r'F:\virtus_test\asm_file\Sim.json'
    if not os.path.isdir(ExtTrain):
        os.makedirs(ExtTrain)
    SimDict = dict()

    OriFileList = os.listdir(ExtTrain)
    for i in OriFileList:
        with open(os.path.join(ExtTrain, i), 'r') as f:
            data = json.load(f)
        FileName = i
        print FileName
        for Fun in data:

            for block in data[Fun]:
                if data[Fun][block]['Sim'] in SimDict:
                    AddMark = 0
                    # print "data[Fun][block]['Sim']" , data[Fun][block]['Sim']
                    while data[Fun][block]['Sim'] + str(AddMark) in SimDict:
                        # print data[Fun][block]['Sim'] + str(AddMark)
                        AddMark += 1
                    # print 'AddMark' , AddMark
                    # print "data[Fun][block]['Sim'] + str(AddMark)" , data[Fun][block]['Sim'] + str(AddMark),'\n'
                    SimDict[data[Fun][block]['Sim'] + str(AddMark)] = {'FileName': FileName, 'FuncName': Fun,
                                                                       'BlockName': block}
                else:
                    SimDict[data[Fun][block]['Sim']] = {'FileName': FileName, 'FuncName': Fun, 'BlockName': block}

    with open(SimOutPath, 'w') as f:
        json.dump(SimDict, f, indent=4)

# OriFileList = os.listdir(ExtTrain)
    # for i in OriFileList:
    #     with open(os.path.join(ExtTrain, i), 'r') as f:
    #         data = json.load(f)
    #     FileName = i
    #     print FileName
    #
    #     for Fun in data:
    #         listBlockUsed = list()
    #         for block1 in data[Fun]:
    #             listBlockUsed.append(block1)
    #             for block2 in data[Fun]:
    #                 if block2 not in listBlockUsed and GSF.isSim(data[Fun][block1]['Sim'], data[Fun][block2]['Sim']) and data[Fun][block1]['Jump']:
    #                     print i + Fun + block1 + '---~---' + i + Fun + block2
