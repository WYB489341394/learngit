import os
import cv2
import numpy as np
from simhash import Simhash
import time

def get_features(s):
    width = 3
    s = s.lower()
    # s = re.sub(r'[^\w]+', '', s)
    box = []
    # print len(s)
    for i in range(0,len(s),3):
        # print i
        box.append(s[i:i+3])
    return box
    # return [s[i:i+width] for i in range(max(len(s) - width + 1, 1),3)]


def get_Point(OpCode):
    # print get_features(OCode)
    # print Simhash(get_features(OpCode)).value
    # B = get_features(OpCode)
    # C = Simhash(get_features(OpCode)).value
    _16bit_simhash = Simhash(get_features(OpCode),f=16).value
    _16bit_simhash_binary = bin(_16bit_simhash)[2:]
    if len(_16bit_simhash_binary) < 16:
        _16bit_simhash_binary = _16bit_simhash_binary.zfill(16)

    X = _16bit_simhash_binary[:8]
    Y = _16bit_simhash_binary[8:]

    X = int('0b'+X,2)
    Y = int('0b'+Y,2)

    # print X, Y,'\n'
    return X, Y

def get_Image(InputfilePath,OutputfilePath):
    fo = open(InputfilePath, "r")

    image = np.zeros((256,256), np.uint8)
    # image = np.zeros((256, 256))
    strr = fo.readlines()

    # count = 0
    for str in strr:
        if len(str) != 0:
            # count +=1
            X,Y = get_Point(str)
            # print X,Y,'\n'
            if image[X,Y] < 240:
                image[X,Y] += 16
    # print count
    # print image
    # a = np.nonzero(image)
    # length = len(a[0])
    # max = np.max(image)
    # maxare = np.unravel_index(image.argmax(), image.shape)
    # # print 1
    #
    # print 4

    cv2.imwrite(OutputfilePath, image)

if __name__ == '__main__':
    time_start = time.time()
    malwarePath = r'F:\virtus_test\10virtus_func'
    imagePath = r'F:\virtus_test\FuncOpcodeHashImage_v2'

    # malwarePath = r'F:\virtus_test\3virtus_func'
    # imagePath = r'F:\virtus_test\FuncOpcodeHashImage2'
    number = 0

    # make folder that all Image in
    if not os.path.isdir(imagePath):
        os.makedirs(imagePath)

    # Traverse all files and get the Image of the corresponding one
    list_dirs = os.walk(malwarePath)
    for root, dirs, files in list_dirs:
        for d in dirs:
            if not os.path.isdir(os.path.join(imagePath, d)):
                os.makedirs(os.path.join(imagePath, d))

        for f in files:
            pathPart = root.split("\\")
            ImageFamilyPath = os.path.join(imagePath, pathPart[len(pathPart) - 1])
            ImageFilePath = os.path.join(ImageFamilyPath, f)
            print os.path.join(root, f)
            # print ImageFilePath
            # get_Image(os.path.join(root, f), ImageFilePath + '.jpg')
            try:
                # print '----------------------------'
                get_Image(os.path.join(root, f), ImageFilePath+'.jpg')
                # print '----------------------------'
            except:
                # show Messages "!!!" when can`t translate malware to Image
                print os.path.join(root, f) + '!!!--> ".jpg"'
                number = number + 1
            # print 'point'
    print 'Finish! number of the lost samples is ' + str(number)

    time_end = time.time()
    print'Time cost is ', (time_end - time_start) / 60, 'min'